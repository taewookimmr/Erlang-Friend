## Chapter 3. 기본 모바일 서버 만들기

### 1. 서버 설계

* 온라인 게임과 모바일 게임 비교

    * User 수의 차이 : 모바일 게임의 접속자가 상대적으로 높다. 
    * 네트워크의 차이 
        * 온라인 게임은 PC 기반의 Ethernet or LAN이라는 안정적인 환경만 고려, 네트워크가 상대적으로 안정적
        * 모바일 게임은 접속이 끊어지는 경우가 빈번 

    * 모바일 게임의 주요 장르가 특징적이다. 
        * 단순하다
        * 온라인 게임 유저당 분당 패킷 수가 수백, 수천 정도라면
        * 모바일에서는 유저당 분당 패킷 수가 10 정도면 많은 편, 이렇게 적다보니 패킷 구조의 최적화는 필요없다. 다만 패킷의 암호화는 필수 

* 서버를 기능별로 분리하는 방법은 노 추천
    
    * 확장하는 방법이 좋다
    * 물리적인 서버를 늘리는 방법은 scale-out
    * 성능 좋은 서버로 대체하는 것은 scale-up

* CPU core가 많다고 마냥 좋은 것인가? 그건 아닐 것 같다.

    * Amdahl's law : 시스템의 일부를 개선할 때, 전체 시스템의 관점에서 성능 향상이 얼마나 있는 지 estimate하는데 사용하는 법칙 

    * Parallel portion에 따라(Variable z), Number of Processors(Variable x)에 따른 SpeedUp(Variable y)가 어떻게 변하는 지 나타내는 것인데, empirical하게 얻어진 데이터를 plotting 했겠지, 아니면 어떤 이론에 근거하여 얻은 수식을 plotting한 것이거나
        * Gergia Tech 영상이 있네 : [영상](https://www.youtube.com/watch?v=BxH93LTSOFo)


    * 여기서 중요한 것은 : 병렬성을 높여서 SpeedUp을 도모해야 한다는 것, 즉 프로그램을 멀티 프로세서에 적합하도록 작성해야 한다는 것 : 프로그램의 각 기능들이 동시성에 충족됨과 동시에 병렬화가 가능한 구조여야 한다는 것이다.

* Concurrency and Parallelism

    * 병렬 : 물리적으로 구분되는 공간들에서, 동시에(비동기적으로) 각각 같은 작업이 진행되는 것을 두고 병렬적으로 작동한다고 표현

    * 병행 : 어느 하나의 물리적이 공간에서 동시에(실제로는 동시가 아닌, 멀티 쓰레딩을 떠올려보자) 여러 작업들이 진행되는 것

    * 병행에서 중요한 것은 병행적으로 수행되는 기능들의 빠른 반응성이다. 
        * 얼랭은 프로세스에 대해 선점형 스케줄링을 한다.  선점, 비선점의 차이가 반응성을 좌우한다.
    
    * 얼랭도 내부 c 소스코드에는 mutex, spinlock이 있다. 그렇지만 erlang 사용자는 신경 쓸 필요 없다.

* 얼랭의 방식

    * 패턴 매칭과 문법은 Prolg에서 영향을 받았다고 한다. message 부분은 smalltalk에서 영향

    * 얼랭의 프로세스는 자기만의 메모리를 가지고 있다. 

    * 얼랭 프로세스가 너무 많이 생길 때 문제가 발생할 수 있지 않냐는 걱정이 있지만, 얼랭 프로세스는 매우 가벼워서 컨텍스트 스위칭도 빠르고 가볍게 동작한다. 

    * Fault Tolerance. erlang에는 Let it crash라는 철학이 있다!

### 2. 기본 모바일 서버 만들기

* 실제 개발 작업에서 클라이언트와 연동하기 위해 먼저 해야 할 것 : 프로토콜 정의

* 프로토콜은 전송규약이다.

    * 클라이언트와 서버간의 데이터(패킷)을 어떤 모양으로 주고 받을지 정하는 것이 프로토콜

    * TCP, UDP의 차이 정확하게 배운다. 직접 작성해봐야 감을 잡으므로, 나중에 다시 와서 여기를 채우도록 하겠다.

    * 모바일 게임의 경우 클라이언트와 서버간의 패킷의 신뢰성을 보장해야 하므로 TCP를 선택하는 것이 맞다. 

* Transport layer에서는 TCP를 기반으로 작성하기로 하자, Application Layer에서는 어떤 프로토콜을 작성할 것인가? 성능이 중요하다면 자체 프로토콜을 작성해서 사용하는 것 추천 

* 모바일 서버에 어울리는 프로토콜은 HTTP이다. 


### 3. Erlang의 HTTP Server

* HTTP Server로 가장 유명한 것은 Apache, IIS
    * 이것들을 사용하지 않고 Erlang으로 작성된 HTTP Server(Web Server)를 작성하는 것의 이점은?
    * 유저의 세션 하나당 웹서버가 하나씩 동작하는 것이 가능하다.

* 얼랭에는 자체적으로 HTTP Server가 내장되어 있다. 
* 얼랭 모듈인 inets의 http server는 간단한 기능만 제공하므로 사용하지 않을 것, 대신 오픈소스 프로젝트 중에서 하나를 선택할 것

* 오픈소스 HTTP Server (Cowboy : 성능 굿, Yaws : 기능 다, Mochiweb: 단순 굿)
* 여기서는 Cowboy를 사용할 것이다.



`


